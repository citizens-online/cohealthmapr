---
title: "Age and Digital Exclusion risk overview map:\nGP surgeries in England"
output: 
  html_document: 
    fig_caption: yes
    keep_md: yes
    smart: no
    theme: united
    css: style.css
mainfont: Source Sans Pro
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE, echo = FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(extrafont)
library(dplyr)
suppressPackageStartupMessages(library(tmap))
suppressPackageStartupMessages(library(sf))
library(leaflet)
library(leaflet.extras)
library(htmlwidgets)
```


### Map guidance

The map below shows the location of 6,690 GP surgeries in England. The [full list](https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/march-2020) (March 2020) contains 6,801 surgeries but 111 of these have data missing and are not included in the map.

Each surgery is colour-coded according to the number of people aged 65+ on its register (<span style="color: `r viridisLite::viridis(n = 5)[[1]]`; background-color: #d9d9d9;">**purple**</span> means the surgery is in the top or "oldest" quintile (20%) of surgeries by age; <span style="color: `r viridisLite::viridis(n = 5)[[5]]`; background-color: #393939;">**yellow**</span> means it is one of the 20% "youngest" (least people aged 65+)).

The circle representing each surgery is also sized according to the *total* number of patients registered there (larger means more patients).

The map is made up of two layers, which may be switched on and off using the layers feature on the left of the map.

- One layer contains those surgeries where _more than_ 30%* of patients are registered for one of three online services (making appointments, ordering repeat prescriptions, looking up personal details) - this is 2,770 surgeries (41%).
- The other layer shows those where _less than_ 30% of patients are registered for the available online services (3,920, or 59% of surgeries).

**We believe these surgeries with less than 30% registered (as of February 2020) should be a priority for targeted digital skills support, as they are more likely to have patients who lack digital skills.** Within this group, those with higher numbers of older patients may be further prioritised.

This is only one way in which digital exclusion can be estimated, however, and we acknowledge that of course many patients who are not registered for GP online services may still have the digital skills and access to devices and the internet that they would need to register.



```{r tmap, warning=FALSE, echo = FALSE, out.width="100%", out.height = "600px"}

suppressMessages(tmap_mode("view"))

full_data_sf <- readRDS("full_data_sf.Rds")

full_data_map <- tm_basemap("OpenStreetMap") +
  tm_shape(full_data_sf %>%
             filter(offline_pat_pct < 70), name = "GP Surgeries in England (>30% using GP online services)") +
  tm_bubbles(size = "total_patients",
             col = "older_popn_quintile",
             title.col = "Number of patients aged 65+<br>(quintiles; 5 = most)",
             palette = "-viridis",
             scale = 0.05,
             alpha = 0.75,
             jitter = 0.01,
             # legend.col.show = FALSE,
             id = "practice_name",
             popup.vars = c(
               "Postcode" = "postcode",
               "Total number of patients" = "total_patients",
               "Number of patients aged 65+" = "older_popn_unwtd",
               "% patients not registered for an online service" = "offline_pat_pct",
               "Online transactions in Feb 2020" = "total_use")) +
  tm_shape(full_data_sf %>%
             filter(offline_pat_pct >= 70), name = "GP Surgeries in England (<30% using GP online services)") +
  tm_bubbles(size = "total_patients",
             col = "older_popn_quintile",
             title.col = "Number of patients aged 65+<br>(quintiles; 5 = most)",
             palette = "-viridis",
             scale = 0.05,
             alpha = 0.75,
             # jitter = 0.01,
             # legend.col.show = FALSE,
             id = "practice_name",
             popup.vars = c(
               "Postcode" = "postcode",
               "Total number of patients" = "total_patients",
               "Number of patients aged 65+" = "older_popn_unwtd",
               "% patients not registered for an online service" = paste0("offline_pat_pct", "%"),
               "Online transactions in Feb 2020" = "total_use"))

```

```{r leaflet, out.width="100%", out.height = "600px"}

# full_data <- readRDS("full_data.Rds")

viridis_palette <- colorQuantile(palette = "viridis", domain = full_data_sf$older_popn_wtd, n = 5, reverse = TRUE)

full_data_under70 <- dplyr::filter(full_data_sf, offline_pat_pct < 70)
full_data_over70 <- dplyr::filter(full_data_sf, offline_pat_pct >= 70)

full_data_sf %>% 
  leaflet() %>% 
  enableTileCaching() %>%
  addProviderTiles(providers$CartoDB.Positron, options = tileOptions(minZoom = 7, maxZoom = 14)) %>% 
  leaflet::addCircles(
    data = full_data_under70,
    radius = ~`^`(total_patients, 0.625),
    stroke = TRUE,
    color = "#708090",
    weight = 3,
    opacity = 0.75,
    fill = TRUE,
    fillColor = ~viridis_palette(older_popn_wtd),
    fillOpacity = 0.75,
    label = ~practice_name,
    group = "More than 30% patients registered for online services",
    popup = paste0(
      "<table><tr><th><h3>", full_data_under70$practice_name, "</h3></th><th style = 'font-weight: 400;'>", full_data_under70$postcode, "</th></tr>",
      "<tr><td>Total number of patients:</td><td style='text-align: right'><strong>", full_data_under70$total_patients, "</strong></td></tr>",
      "<tr><td>Number of patients aged 65+:</td><td style='text-align: right'><strong>", full_data_under70$older_popn_unwtd, "</strong></td></tr>",
      "<tr><td>% patients <em>not</em> reg'd for an online service:</td><td style='text-align: right'><strong>", full_data_under70$offline_pat_pct, "%</strong></td></tr>",
      "<tr><td>Online transactions in Feb 2020:</td><td style='text-align: right'><strong>", full_data_under70$total_use, "</strong></td></tr></table>")) %>% 
  leaflet::addCircles(
    data = full_data_over70,
    radius = ~`^`(total_patients, 0.625),
    stroke = TRUE,
    color = "#ee1289",
    weight = 3,
    opacity = 0.75,
    fill = TRUE,
    fillColor = ~viridis_palette(older_popn_wtd),
    fillOpacity = 0.75,
    label = ~practice_name,
    group = "Less than 30% patients registered for online services",
    popup = paste0(
      "<table><tr><th><h3>", full_data_over70$practice_name, "</h3></th><th style = 'font-weight: 400;'>", full_data_over70$postcode, "</th></tr>",
      "<tr><td>Total number of patients:</td><td style='text-align: right'><strong>", full_data_over70$total_patients, "</strong></td></tr>",
      "<tr><td>Number of patients aged 65+:</td><td style='text-align: right'><strong>", full_data_over70$older_popn_unwtd, "</strong></td></tr>",
      "<tr><td>% patients <em>not</em> reg'd for an online service:</td><td style='text-align: right'><strong>", full_data_over70$offline_pat_pct, "%</strong></td></tr>",
      "<tr><td>Online transactions in Feb 2020:</td><td style='text-align: right'><strong>", full_data_over70$total_use, "</strong></td></tr></table>")) %>% 
  addLayersControl(overlayGroups = c("More than 30% patients registered for online services", "Less than 30% patients registered for online services"), position = "topleft",
  # options = leaflet::layersControlOptions(collapsed = FALSE)
  ) %>% 
  addLegend(
    position = "topright",
    colors = viridisLite::viridis(5, direction = -1, alpha = 1),
    opacity = 1,
    title = "Number of patients aged 65+<br>(quintiles; 5 = most)",
    labels = as.character(1:5)) %>% 
  leaflet.extras::addFullscreenControl(position = "topleft", pseudoFullscreen = FALSE) %>% 
  saveWidget("leaflet_widget1.html")

full_data_sf %>% 
  leaflet() %>% 
  enableTileCaching() %>%
  addProviderTiles(providers$CartoDB.Positron, options = tileOptions(minZoom = 7, maxZoom = 14)) %>% 
  leaflet::addCircles(
    data = dplyr::filter(full_data_sf, offline_pat_pct >= 70),
    radius = ~`^`(total_patients, 0.6),
    stroke = TRUE,
    color = ~viridis_palette(older_popn_wtd),
    weight = 5,
    opacity = 0.75,
    fill = TRUE,
    fillColor = ~viridis_palette(older_popn_wtd),
    # fillColor = "#EE1289",
    fillOpacity = 0.9,
    label = ~practice_name,
    group = "Less than 30%"
    ) %>% 
  leaflet::addCircles(
    data = dplyr::filter(full_data_sf, offline_pat_pct < 70),
    radius = ~`^`(total_patients, 0.6),
    stroke = TRUE,
    color = ~viridis_palette(older_popn_wtd),
    weight = 5,
    opacity = 0.75,
    fill = TRUE,
    fillColor = "#708090",
    fillOpacity = 0.4,
    label = ~practice_name,
    group = "More than 30%"
    ) %>% 
  leaflet.extras::addFullscreenControl(position = "topleft", pseudoFullscreen = TRUE) %>% 
  saveWidget("leaflet_widget2.html")
```


### Sources and notes
1. Data on availability and use of online services is from [the NHS Digital website](https://digital.nhs.uk/data-and-information/data-collections-and-data-sets/data-collections/pomi), latest data February 2020.

2. Surgery name, size and location data are also obtained from [NHS Digital](https://digital.nhs.uk/data-and-information/publications/statistical/patients-registered-at-a-gp-practice/march-2020) (March 2020). NB the number of patients reported in this dataset is frequently quite different from the patient list size reported in (1).

3. Postcode lookup to grid location is provided by the [ONS Postcode Directory](https://geoportal.statistics.gov.uk/datasets/ons-postcode-directory-february-2020) - latest version February 2020.

4. The basemap is provided by [OpenStreetMap](https://openstreetmap.org).

In calculating the ranking of surgeries by number of older people (65+) registered, we have applied weightings to the reported populations such that the number of patients in older 5-year sub-brackets are given increasingly greater prominence. The number of patients aged 65+ reported in the pop-up data bubbles on the map is the unweighted (actual) number of people, however.

*30% registered is approximately the average (mean) proportion of patients currently registered, nationally.

### Get in touch

The map above uses the _national_ ranking of each surgery for age i.e. purple means it is in the top 20% _nationally_ for number of older patients. Citizens Online is able to provide you with maps with more localised data, so you can see which are the locations with more older people registered, with quintiles reset to local levels. Please get in touch to find out how we can help you with our mapping and analysis services.

We also welcome comments and feedback about the map above and how it might be improved. Please email [francis.barton@citizensonline.org.uk](mailto:francis.barton@citizensonline.org.uk) with your comments or use the contact form below.

